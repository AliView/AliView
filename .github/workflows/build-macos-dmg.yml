name: Build macOS DMG

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-dmg:
    strategy:
      matrix:
        include:
          - os: macos-14
            arch: x64
          - os: macos-14
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Build DMG via jpackage
        run: |
          echo "GITHUB_RUN_NUMBER=${GITHUB_RUN_NUMBER}"
          chmod +x jpackage/jpackage-mac.sh
          VERSION=$(python3 - <<'PY'
          import xml.etree.ElementTree as ET
          tree = ET.parse("pom.xml")
          root = tree.getroot()
          ns = {"m": root.tag.split("}")[0].strip("{")}
          print(root.find("m:version", ns).text)
          PY
          )
          PATCH=${GITHUB_RUN_NUMBER}
          JPACKAGE_TYPES=dmg APP_VERSION="${VERSION}.${PATCH}" ./jpackage/jpackage-mac.sh
          VERSION=$(python3 - <<'PY'
          import xml.etree.ElementTree as ET
          tree = ET.parse("pom.xml")
          root = tree.getroot()
          ns = {"m": root.tag.split("}")[0].strip("{")}
          print(root.find("m:version", ns).text)
          PY
          )
          DMG=$(ls target/jpackage-mac/*.dmg | head -n 1)
          mv "$DMG" "target/jpackage-mac/AliView-${VERSION}-macOS-${{ matrix.arch }}.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: AliView-${{ matrix.arch }}-DMG
          path: target/jpackage-mac/AliView-*-macOS-${{ matrix.arch }}.dmg
